<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SNF Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7fafc; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669; --danger:#dc2626; --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:#fff;position:sticky;top:0;z-index:10}
    .brand{font-weight:700}
    #version{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;padding:10px 20px 0;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:56px;z-index:9}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;background:#fdfdfd;
      border-top-left-radius:10px;border-top-right-radius:10px;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--card);color:var(--text);font-weight:600}
    main{padding:18px 20px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .grow{flex:1 1 220px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.success{background:var(--accent-2);color:#fff;border-color:var(--accent-2)}
    .btn.warn{background:#fff;color:var(--warn);border-color:var(--warn)}
    .btn.small{padding:6px 10px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .error{color:var(--danger);font-size:12px;margin-top:6px}
    .success{color:var(--accent-2);font-size:12px;margin-top:6px}
    .warntext{color:var(--warn);font-size:12px;margin-top:6px}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--border);text-align:left;font-weight:600;padding:10px;white-space:nowrap;cursor:pointer;user-select:none}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top;white-space:nowrap}
    tbody tr:nth-child(even){background:#fcfcfd}
    .sort-arrow{font-size:10px;margin-left:6px;color:var(--muted)}
    .empty{padding:10px;color:var(--muted)}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .modal{background:#fff;border-radius:16px;max-width:780px;width:100%;border:1px solid var(--border);box-shadow:0 8px 28px rgba(0,0,0,.15)}
    .modal header{border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .modal .content{padding:16px}
    /* Autocomplete */
    .ac-wrap{position:relative}
    .ac-list{position:absolute;z-index:40;top:calc(100% + 6px);left:0;right:0;background:#fff;border:1px solid var(--border);
      border-radius:10px;max-height:240px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.08);display:none}
    .ac-item{padding:10px 12px;cursor:pointer}
    .ac-item:hover{background:#f4f6fb}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5ff;color:#1e3a8a;border-radius:999px;padding:6px 10px;font-size:12px}
    .pill .x{cursor:pointer}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-bottom:10px}
    @media (max-width:640px){ .toolbar{flex-direction:column;align-items:flex-start;gap:8px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">SNF Dashboard</div>
    <div id="version">SNF UI v0.27</div>
  </header>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="clients">Clients</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="groups">Groups</div>
    <div class="tab" data-tab="roi">Group ROI</div>
    <div class="tab" data-tab="contacts">Contacts</div>
  </div>

  <main>
    <!-- Clients Panel -->
    <section class="panel" id="panel-clients">
      <div class="toolbar">
        <div><strong>Clients</strong> <span class="muted">— add and manage clients</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-clients">Refresh</button>
          <!-- Add Client button ONLY on Clients tab -->
          <button class="btn primary" id="btn-add-client">+ Add Client</button>
        </div>
      </div>

      <div id="clients-status" class="muted" style="margin-bottom:8px">Loading clients…</div>
      <div class="table-wrap" id="clients-table-wrap" style="display:none">
        <table id="clients-table" aria-label="Clients"></table>
      </div>
    </section>

    <!-- Payments (placeholder) -->
    <section class="panel" id="panel-payments" style="display:none">
      <div class="muted">Payments tab placeholder.</div>
    </section>

    <!-- Groups Panel -->
    <section class="panel" id="panel-groups" style="display:none">
      <div class="toolbar">
        <div><strong>Groups</strong> <span class="muted">— list and add groups</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-groups">Refresh</button>
          <button class="btn success" id="btn-toggle-add-group">Add Group</button>
        </div>
      </div>

      <!-- Add Group Form (collapsible) -->
      <div id="add-group-wrap" class="panel" style="margin-bottom:12px; display:none; border:1px dashed var(--border);">
        <form id="add-group-form" autocomplete="off">
          <div class="row">
            <div class="grow">
              <div class="label">Year</div>
              <select class="input" name="year" id="year-select" required></select>
            </div>
            <div class="grow">
              <div class="label">Group Name</div>
              <input class="input" name="group_name" id="group-name" placeholder="e.g., Divorce Professionals Network" required />
            </div>
            <div class="grow">
              <div class="label">Date Started</div>
              <input class="input" type="date" name="date_started" required />
            </div>
            <div class="grow">
              <div class="label">Total Amount</div>
              <input class="input" type="number" step="0.01" min="0" name="total_amount" placeholder="0.00" required />
            </div>
          </div>
          <div id="group-form-msg" class="muted" style="margin-top:8px"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button type="button" class="btn" id="btn-cancel-add-group">Cancel</button>
            <button type="button" class="btn success" id="btn-save-group">Save Group</button>
          </div>
        </form>
      </div>

      <div id="groups-status" class="muted" style="margin-bottom:8px">Loading groups…</div>
      <div class="table-wrap" id="groups-table-wrap" style="display:none">
        <table id="groups-table" aria-label="Groups"></table>
      </div>
    </section>

    <!-- Group ROI Panel -->
    <section class="panel" id="panel-roi" style="display:none">
      <div class="toolbar">
        <div><strong>Group ROI</strong> <span class="muted">— filter by group and year</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-roi">Refresh</button>
        </div>
      </div>

      <div class="filters">
        <div class="grow" style="max-width:260px;">
          <div class="label">Group</div>
          <select class="input" id="roi-group-select">
            <option value="ALL">ALL</option>
          </select>
        </div>
        <div class="grow" style="max-width:180px;">
          <div class="label">Year</div>
          <select class="input" id="roi-year-select">
            <option value="ALL">ALL</option>
          </select>
        </div>
        <div>
          <button class="btn primary" id="btn-load-roi">Load</button>
        </div>
      </div>

      <div id="roi-status" class="muted" style="margin-bottom:8px">Adjust filters and click Load.</div>
      <div class="table-wrap" id="roi-table-wrap" style="display:none">
        <table id="roi-table" aria-label="Group ROI"></table>
      </div>
    </section>

    <!-- Contacts Panel -->
    <section class="panel" id="panel-contacts" style="display:none">
      <div class="toolbar">
        <div><strong>Contacts</strong> <span class="muted">— shows group name via view</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-contacts">Refresh</button>
        </div>
      </div>
      <div id="contacts-status" class="muted" style="margin-bottom:8px">Loading contacts…</div>
      <div class="table-wrap" id="contacts-table-wrap" style="display:none">
        <table id="contacts-table" aria-label="Contacts"></table>
      </div>
    </section>
  </main>

  <!-- Add Client Modal -->
  <div class="modal-backdrop" id="add-modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <div class="brand">Add Client</div>
        <button class="btn" id="btn-close-x" aria-label="Close">✕</button>
      </header>
      <div class="content">
        <form id="add-client-form" autocomplete="off">
          <div class="row">
            <div class="grow">
              <div class="label">First Name</div>
              <input class="input" name="first_name" required />
            </div>
            <div class="grow">
              <div class="label">Last Name</div>
              <input class="input" name="last_name" required />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <div class="label">Email</div>
              <input class="input" type="email" name="email" />
            </div>
            <div class="grow">
              <div class="label">Phone</div>
              <input class="input" name="phone" placeholder="+15555550123" />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <div class="label">Referred By (optional — type at least 2 characters)</div>
              <div class="ac-wrap">
                <input class="input" id="ref-search" placeholder="e.g., Smith, Jane  or  jane@company.com" />
                <div class="ac-list" id="ref-list"></div>
              </div>
              <!-- Hidden fields sent to Worker -->
              <input type="hidden" name="referred_by_id" id="ref-ghl-id" />
              <input type="hidden" name="referred_by_first_name" id="ref-first" />
              <input type="hidden" name="referred_by_last_name" id="ref-last" />
              <div id="ref-pill" style="margin-top:8px; display:none;" class="pill">
                <span id="ref-pill-text"></span>
                <span class="x" id="ref-pill-x">✕</span>
              </div>
              <div class="muted" style="margin-top:6px; display:flex; gap:10px; align-items:center;">
                <button type="button" class="btn small" id="ref-skip">Skip referrer</button>
              </div>
            </div>
          </div>

          <div id="form-msg" class="muted" style="margin-top:10px"></div>
        </form>
      </div>
      <footer>
        <button class="btn" id="btn-cancel">Cancel</button>
        <button class="btn primary" id="btn-save">Save Client</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Config: Worker base URLs =====
    const API_ADD_CLIENT     = 'https://snf-add-client.dennis-e64.workers.dev';
    const API_SEARCH_CONTACT = 'https://snf-search-contacts.dennis-e64.workers.dev';
    const API_LIST_CLIENTS   = 'https://snf-list-clients.dennis-e64.workers.dev';

    const API_LIST_GROUPS    = 'https://snf-list-groups.dennis-e64.workers.dev';
    const API_ADD_GROUP      = 'https://snf-add-group.dennis-e64.workers.dev';

    const API_LIST_CONTACTS  = 'https://snf-list-contacts.dennis-e64.workers.dev';

    const API_GROUP_ROI      = 'https://snf-list-group-roi.dennis-e64.workers.dev'; // expects optional ?group= & year=

    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      clients:  document.getElementById('panel-clients'),
      payments: document.getElementById('panel-payments'),
      groups:   document.getElementById('panel-groups'),
      roi:      document.getElementById('panel-roi'),
      contacts: document.getElementById('panel-contacts'),
    };
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      Object.values(panels).forEach(p => p.style.display='none');
      panels[t.dataset.tab].style.display = '';
    }));

    // ===== Utilities =====
    const fmtCurrency = (n) => {
      if (n === null || n === undefined || isNaN(n)) return '';
      return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(n));
    };
    const fmtPercent = (n) => {
      if (n === null || n === undefined || isNaN(n)) return '';
      // Accept 0.25 as 25% or 25 as 25%
      const val = Number(n);
      const p = val > 1 ? val/100 : val;
      return new Intl.NumberFormat('en-US',{style:'percent',minimumFractionDigits:2,maximumFractionDigits:2}).format(p);
    };

    // ====== CLIENTS ======
    const clientsStatus = document.getElementById('clients-status');
    const clientsTableWrap = document.getElementById('clients-table-wrap');
    const clientsTable = document.getElementById('clients-table');
    document.getElementById('btn-refresh-clients').addEventListener('click', loadClients);

    async function loadClients(){
      clientsStatus.textContent = 'Loading clients…';
      clientsTableWrap.style.display = 'none';
      clientsTable.innerHTML = '';
      try {
        const url = new URL('/', API_LIST_CLIENTS);
        const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || text || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        clientsStatus.textContent = rows.length ? `Loaded ${rows.length} client${rows.length===1?'':'s'}.` : 'No clients found.';
        if (!rows.length) return;

        renderClientsTable(rows);
        clientsTableWrap.style.display = '';
      } catch (err){
        clientsStatus.textContent = `Error loading clients: ${err.message}`;
      }
    }

    function renderClientsTable(rows){
      // Preferred columns (no IDs; referral names only)
      const preferred = [
        'first_name','last_name',
        'email','phone',
        'referred_by_first_name','referred_by_last_name',
        'created_at','updated_at'
      ];
      const HIDE = new Set(['id','client_id','referred_by_id']); // Always hidden

      const keySet = new Set();
      rows.forEach(r => Object.keys(r || {}).forEach(k => { if (!HIDE.has(k)) keySet.add(k); }));
      const allKeys = Array.from(keySet);
      const ordered = [
        ...preferred.filter(k => keySet.has(k)),
        ...allKeys.filter(k => !preferred.includes(k)).sort((a,b)=> a.localeCompare(b))
      ];

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ordered.forEach(k => {
        const th = document.createElement('th');
        th.textContent = prettifyHeader(k);
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        ordered.forEach(k => {
          const td = document.createElement('td');
          let v = r[k];
          if (v === null || v === undefined) v = '';
          if (Array.isArray(v)) v = v.join(', ');
          if (typeof v === 'object' && v) v = JSON.stringify(v);
          td.textContent = String(v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      clientsTable.innerHTML = '';
      clientsTable.appendChild(thead);
      clientsTable.appendChild(tbody);
    }

    function prettifyHeader(k){
      return k
        .replace(/_/g,' ')
        .replace(/\b(id)\b/i, 'ID')
        .replace(/\b(ghl)\b/i, 'GHL')
        .replace(/\b([a-z])/g, (m)=>m.toUpperCase());
    }

    // ===== Clients Modal (Add) =====
    const modalBackdrop = document.getElementById('add-modal-backdrop');
    const openModal = () => { modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); };
    const closeModal = () => { modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); resetForm(); };
    document.getElementById('btn-add-client').onclick = openModal;
    document.getElementById('btn-cancel').onclick = closeModal;
    document.getElementById('btn-close-x').onclick = closeModal;
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal(); });

    const refInput   = document.getElementById('ref-search');
    const refList    = document.getElementById('ref-list');
    const refGhlId   = document.getElementById('ref-ghl-id');
    const refFirst   = document.getElementById('ref-first');
    const refLast    = document.getElementById('ref-last');
    const refPill    = document.getElementById('ref-pill');
    const refPillText= document.getElementById('ref-pill-text');
    const refPillX   = document.getElementById('ref-pill-x');
    const refSkip    = document.getElementById('ref-skip');
    const formMsg    = document.getElementById('form-msg');

    let acTimer = null;
    refInput.addEventListener('input', () => {
      const q = refInput.value.trim();
      if (acTimer) clearTimeout(acTimer);
      if (q.length < 2) { refList.style.display='none'; return; }
      acTimer = setTimeout(async () => { await loadContactMatches(q); }, 250);
    });
    refPillX.addEventListener('click', clearReferrer);
    refSkip.addEventListener('click', clearReferrer);

    function clearReferrer(){
      refGhlId.value = '';
      refFirst.value = '';
      refLast.value = '';
      refPill.style.display = 'none';
      refList.style.display = 'none';
      refInput.value = '';
      refInput.blur();
    }

    async function loadContactMatches(q) {
      refList.innerHTML = '<div class="ac-item muted">Searching…</div>';
      refList.style.display = 'block';
      try {
        const url = new URL('/snf-search-contacts', API_SEARCH_CONTACT);
        url.searchParams.set('q', q);
        url.searchParams.set('limit', '10');
        const res = await fetch(url.toString(), { method: 'GET', headers: { 'Accept': 'application/json' } });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || txt || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        if (!rows.length) { refList.innerHTML = '<div class="ac-item muted">No matches</div>'; return; }
        rows.sort((a,b) => {
          const la = (a.last_name || '').toLowerCase();
          const lb = (b.last_name || '').toLowerCase();
          if (la !== lb) return la < lb ? -1 : 1;
          const fa = (a.first_name || '').toLowerCase();
          const fb = (b.first_name || '').toLowerCase();
          return fa < fb ? -1 : (fa > fb ? 1 : 0);
        });

        refList.innerHTML = '';
        rows.forEach(r => {
          const div = document.createElement('div');
          const label = `${(r.last_name||'').trim()}, ${(r.first_name||'').trim()} — ${r.email||'no email'}`;
          div.className = 'ac-item';
          div.textContent = label;
          div.onclick = () => {
            refGhlId.value = r.ghl_id || r.id || '';
            refFirst.value = r.first_name || '';
            refLast.value  = r.last_name || '';
            refPillText.textContent = label;
            refPill.style.display = 'inline-flex';
            refList.style.display = 'none';
            refInput.value = '';
          };
          refList.appendChild(div);
        });
      } catch (e) {
        refList.innerHTML = `<div class="ac-item" style="color:var(--danger)">Search error: ${e.message}</div>`;
      }
    }

    document.getElementById('btn-save').addEventListener('click', async () => {
      const form = document.getElementById('add-client-form');
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      const missing = ['first_name','last_name'].filter(k => !payload[k]?.trim());
      if (missing.length) return setMsg('Please fill in First Name and Last Name.', true);
      try {
        setMsg('Saving…');
        const res = await fetch(`${API_ADD_CLIENT}/snf-add-client`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const txt = await res.text(); let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || (txt && txt.trim()) || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        setMsg('Client added successfully!', false, true);
        // Close modal after success and refresh list
        setTimeout(() => { closeModal(); loadClients(); }, 600);
      } catch (e) {
        setMsg(e.message || 'Save failed', true);
      }
    });
    function setMsg(text, isError=false, isSuccess=false){
      formMsg.className = isError ? 'error' : (isSuccess ? 'success' : 'muted');
      formMsg.textContent = text;
    }
    function resetForm(){
      document.getElementById('add-client-form').reset();
      clearReferrer();
      setMsg('', false);
    }

    // ====== GROUPS ======
    const groupsStatus = document.getElementById('groups-status');
    const groupsTableWrap = document.getElementById('groups-table-wrap');
    const groupsTable = document.getElementById('groups-table');
    const btnToggleAddGroup = document.getElementById('btn-toggle-add-group');
    const addGroupWrap = document.getElementById('add-group-wrap');
    const btnCancelAddGroup = document.getElementById('btn-cancel-add-group');
    const btnSaveGroup = document.getElementById('btn-save-group');
    const groupFormMsg = document.getElementById('group-form-msg');
    const yearSelect = document.getElementById('year-select');

    // Populate Year dropdown (2025 → +10y ascending)
    (function initYears(){
      const start = 2025;
      for (let y=start; y<=start+10; y++){
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        yearSelect.appendChild(opt);
      }
    })();

    document.getElementById('btn-refresh-groups').addEventListener('click', loadGroups);
    btnToggleAddGroup.addEventListener('click', () => {
      addGroupWrap.style.display = addGroupWrap.style.display === 'none' ? '' : 'none';
    });
    btnCancelAddGroup.addEventListener('click', () => {
      document.getElementById('add-group-form').reset();
      groupFormMsg.textContent = '';
      addGroupWrap.style.display = 'none';
    });
    btnSaveGroup.addEventListener('click', saveGroup);

    async function loadGroups(){
      groupsStatus.textContent = 'Loading groups…';
      groupsTableWrap.style.display = 'none';
      groupsTable.innerHTML = '';
      try {
        const url = new URL('/', API_LIST_GROUPS);
        const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || text || `HTTP ${res.status}`);

        let rows = (data && data.rows) || [];
        // default sort A→Z by group_name
        rows.sort((a,b)=> (a.group_name||'').localeCompare(b.group_name||''));

        groupsStatus.textContent = rows.length ? `Loaded ${rows.length} group${rows.length===1?'':'s'}.` : 'No groups found.';
        if (!rows.length) return;

        renderGroupsTable(rows);
        groupsTableWrap.style.display = '';
      } catch (err){
        groupsStatus.textContent = `Error loading groups: ${err.message}`;
      }
    }

    function renderGroupsTable(rows){
      const head = [
        { key:'group_name', label:'Group Name', type:'text' },
        { key:'total_amount', label:'Total Amount', type:'currency' },
        { key:'total_referral_amount', label:'Total Referral Amount', type:'currency' },
        { key:'total_roi', label:'Total ROI', type:'percent' },
        { key:'date_started', label:'Date Started', type:'date' },
      ];

      let sortKey = 'group_name';
      let sortAsc = true;

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      head.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h.label;
        th.classList.add('sortable');
        const arrow = document.createElement('span'); arrow.className='sort-arrow'; arrow.textContent='▲';
        th.appendChild(arrow);
        th.onclick = () => {
          if (sortKey === h.key) { sortAsc = !sortAsc; }
          else { sortKey = h.key; sortAsc = true; }
          const multiplier = sortAsc ? 1 : -1;
          rows.sort((a,b)=>{
            const va = a[sortKey]; const vb = b[sortKey];
            if (va == null && vb == null) return 0;
            if (va == null) return 1;
            if (vb == null) return -1;
            if (typeof va === 'number' && typeof vb === 'number') return (va - vb)*multiplier;
            return String(va).localeCompare(String(vb)) * multiplier;
          });
          renderBody();
          arrow.textContent = sortAsc ? '▲' : '▼';
          // reset other headers arrows
          Array.from(thead.querySelectorAll('.sort-arrow')).forEach(el => { if (el!==arrow) el.textContent='▲'; });
        };
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      function renderBody(){
        tbody.innerHTML = '';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          head.forEach(h=>{
            const td=document.createElement('td');
            let v=r[h.key];
            if (h.type==='currency') v = (v==null||v==='')?'':fmtCurrency(v);
            else if (h.type==='percent') v = (v==null||v==='')?'':fmtPercent(v);
            else if (h.type==='date' && v) v = String(v).slice(0,10);
            td.innerHTML = (v==null||v==='')?'<span class="muted">—</span>':String(v);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      renderBody();

      groupsTable.innerHTML='';
      groupsTable.appendChild(thead);
      groupsTable.appendChild(tbody);
    }

    async function saveGroup(){
      const form = document.getElementById('add-group-form');
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      if (!payload.group_name || !payload.year || !payload.date_started || !payload.total_amount){
        groupFormMsg.className='error'; groupFormMsg.textContent='Please complete all fields.'; return;
      }
      try{
        groupFormMsg.className='muted'; groupFormMsg.textContent='Saving…';
        const res = await fetch(`${API_ADD_GROUP}/snf-add-group`, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });
        const txt = await res.text(); let data=null; try{ data=JSON.parse(txt); } catch{};
        if (!res.ok){
          const msg = (data && (data.error||data.message)) || (txt && txt.trim()) || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        groupFormMsg.className='success'; groupFormMsg.textContent='Group added successfully!';
        setTimeout(()=>{
          form.reset(); groupFormMsg.textContent=''; addGroupWrap.style.display='none'; loadGroups();
        }, 600);
      } catch(e){
        groupFormMsg.className='error'; groupFormMsg.textContent=e.message || 'Save failed';
      }
    }

    // ====== ROI ======
    const roiStatus = document.getElementById('roi-status');
    const roiTableWrap = document.getElementById('roi-table-wrap');
    const roiTable = document.getElementById('roi-table');
    const roiGroupSel = document.getElementById('roi-group-select');
    const roiYearSel = document.getElementById('roi-year-select');
    document.getElementById('btn-refresh-roi').addEventListener('click', initRoiFilters);
    document.getElementById('btn-load-roi').addEventListener('click', loadROI);

async function initRoiFilters(){
  roiStatus.textContent = 'Loading filters…';

  try {
    // --- Groups ---
    const resG = await fetch(API_LIST_GROUPS, { headers:{'Accept':'application/json'} });
    const txtG = await resG.text(); let dataG = null; try{ dataG = JSON.parse(txtG); }catch{}
    if (resG.ok && dataG && Array.isArray(dataG.rows)) {
      roiGroupSel.innerHTML = '<option value="ALL">ALL</option>';
      dataG.rows
        .map(r=>r.group_name)
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b))
        .forEach(name=>{
          const opt=document.createElement('option'); 
          opt.value=name; 
          opt.textContent=name; 
          roiGroupSel.appendChild(opt);
        });
    }

    // --- Years ---
    const resY = await fetch(API_GROUP_ROI, { headers:{'Accept':'application/json'} });
    const txtY = await resY.text(); let dataY=null; try{ dataY=JSON.parse(txtY);}catch{}
    if (resY.ok && dataY && Array.isArray(dataY.rows)) {
      const years = [...new Set(dataY.rows.map(r=>r.year).filter(Boolean))].sort();
      roiYearSel.innerHTML = '<option value="ALL">ALL</option>';
      years.forEach(y=>{
        const opt=document.createElement('option'); 
        opt.value=String(y); 
        opt.textContent=String(y); 
        roiYearSel.appendChild(opt);
      });
    }

    roiStatus.textContent = 'Filters ready. Click Load.';
  } catch(e){ 
    roiStatus.textContent = 'Error loading filters: ' + e.message;
  }
}

async function loadROI(){
  roiStatus.textContent = 'Loading ROI…';
  roiTableWrap.style.display='none';
  roiTable.innerHTML='';

  try{
    const grp = (roiGroupSel.value || 'ALL').trim();
    const yr  = (roiYearSel.value || 'ALL').trim();

    // Build query string sending both common param names
    const params = [];
    if (grp && grp !== 'ALL') {
      params.push(`group=${encodeURIComponent(grp)}`);
      params.push(`group_name=${encodeURIComponent(grp)}`); // compatibility
    }
    if (yr && yr !== 'ALL') {
      params.push(`year=${encodeURIComponent(yr)}`);
    }

    let url = API_GROUP_ROI; // must be 'https://snf-list-group-roi.dennis-e64.workers.dev'
    if (params.length) url += '?' + params.join('&');

    const res = await fetch(url, { headers:{'Accept':'application/json'} });
    const txt = await res.text();
    let data=null; try{ data=JSON.parse(txt); }catch{}

    if (!res.ok) {
      const msg = (data && (data.error||data.message)) || (txt && txt.trim()) || `HTTP ${res.status}`;
      throw new Error(msg);
    }

    const rows = Array.isArray(data) ? data : (data && data.rows) || [];
    rows.sort((a,b)=>{
      const gn = (a.group_name||'').localeCompare(b.group_name||'');
      return gn!==0 ? gn : String(a.year||'').localeCompare(String(b.year||''));
    });

    roiStatus.textContent = rows.length ? `Loaded ${rows.length} row${rows.length===1?'':'s'}.` : 'No rows found.';
    if (!rows.length) return;

    const columns = [
      { key:'group_name', label:'Group Name' },
      { key:'year', label:'Year' },
      { key:'renewal_date', label:'Renewal Date', fmt:v=>v?String(v).slice(0,10):'' },
      { key:'renewal_amount', label:'Renewal Amount', fmt:fmtCurrency },
      { key:'referral_amount', label:'Referral Amount', fmt:fmtCurrency },
      { key:'roi', label:'ROI', fmt:fmtPercent },
    ];

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; trh.appendChild(th); });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      columns.forEach(c=>{
        const td=document.createElement('td');
        const raw = r[c.key];
        td.innerHTML = (c.fmt ? c.fmt(raw) : (raw ?? '')) || '<span class="muted">—</span>';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    roiTable.appendChild(thead);
    roiTable.appendChild(tbody);
    roiTableWrap.style.display='';
  } catch(e){
    roiStatus.textContent = `Error loading ROI: ${e.message}`;
  }
}

    // ====== CONTACTS ======
    const contactsStatus = document.getElementById('contacts-status');
    const contactsTableWrap = document.getElementById('contacts-table-wrap');
    const contactsTable = document.getElementById('contacts-table');
    document.getElementById('btn-refresh-contacts').addEventListener('click', loadContacts);

    async function loadContacts(){
      contactsStatus.textContent = 'Loading contacts…';
      contactsTableWrap.style.display = 'none';
      contactsTable.innerHTML = '';
      try {
        const url = new URL('/', API_LIST_CONTACTS);
        const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || text || `HTTP ${res.status}`);

        let rows = (data && data.rows) || [];
        contactsStatus.textContent = rows.length ? `Loaded ${rows.length} contact${rows.length===1?'':'s'}.` : 'No contacts found.';
        if (!rows.length) return;

        // default sort by last_name, first_name
        rows.sort((a,b)=>{
          const ln = (a.last_name||'').localeCompare(b.last_name||''); if (ln!==0) return ln;
          return (a.first_name||'').localeCompare(b.first_name||'');
        });

        renderContactsTable(rows);
        contactsTableWrap.style.display = '';
      } catch (err){
        contactsStatus.textContent = `Error loading contacts: ${err.message}`;
      }
    }

    function renderContactsTable(rows){
      const columns = [
        { key:'first_name', label:'First Name' },
        { key:'last_name', label:'Last Name' },
        { key:'group_name', label:'Group' },
        { key:'occupation_type', label:'Occupation Type' },
        { key:'email', label:'Email' },
        { key:'phone', label:'Phone' },
      ];
      const thead=document.createElement('thead');
      const trh=document.createElement('tr');
      columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; trh.appendChild(th); });
      thead.appendChild(trh);
      const tbody=document.createElement('tbody');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        columns.forEach(c=>{
          const td=document.createElement('td');
          let v = r[c.key];
          if (c.key==='group_name') v = v || '(No Group)';
          td.textContent = (v==null || v==='') ? '' : String(v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      contactsTable.innerHTML=''; contactsTable.appendChild(thead); contactsTable.appendChild(tbody);
    }

    // ===== Init (load defaults) =====
    loadClients();
    loadGroups();
    initRoiFilters();
    // Contacts won’t load until user clicks Contacts tab refresh OR we can auto-load here:
    loadContacts();
  </script>
</body>
</html>
