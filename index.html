<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SNF Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7fafc; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .brand{font-weight:700}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;padding:10px 20px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;background:#fdfdfd;
      border-top-left-radius:10px;border-top-right-radius:10px;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--card);color:var(--text);font-weight:600}
    main{padding:18px 20px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .grow{flex:1 1 220px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.small{padding:6px 10px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .modal{background:#fff;border-radius:16px;max-width:680px;width:100%;border:1px solid var(--border);box-shadow:0 8px 28px rgba(0,0,0,.15)}
    .modal header{border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .modal .content{padding:16px}
    /* Autocomplete */
    .ac-wrap{position:relative}
    .ac-list{position:absolute;z-index:40;top:calc(100% + 6px);left:0;right:0;background:#fff;border:1px solid var(--border);
      border-radius:10px;max-height:240px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.08);display:none}
    .ac-item{padding:10px 12px;cursor:pointer}
    .ac-item:hover{background:#f4f6fb}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5ff;color:#1e3a8a;border-radius:999px;padding:6px 10px;font-size:12px}
    .pill .x{cursor:pointer}
    #version{font-size:12px;color:var(--muted)}
    .error{color:var(--danger);font-size:12px;margin-top:6px}
    .success{color:var(--accent-2);font-size:12px;margin-top:6px}
    /* Clients table */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--border);text-align:left;font-weight:600;padding:10px}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top;white-space:nowrap}
    tbody tr:nth-child(even){background:#fcfcfd}
    .empty{padding:10px;color:var(--muted)}
    @media (max-width:640px){ .toolbar{flex-direction:column;align-items:flex-start;gap:8px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">SNF Dashboard</div>
    <div id="version">SNF UI v0.10</div>
  </header>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="clients">Clients</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="groups">Groups</div>
    <div class="tab" data-tab="roi">Group ROI</div>
  </div>

  <main>
    <!-- Clients Panel -->
    <section class="panel" id="panel-clients">
      <div class="toolbar">
        <div><strong>Clients</strong> <span class="muted">— add and manage clients</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-clients">Refresh</button>
          <button class="btn primary" id="btn-add-client">+ Add Client</button>
        </div>
      </div>

      <div id="clients-status" class="muted" style="margin-bottom:8px">Loading clients…</div>
      <div class="table-wrap" id="clients-table-wrap" style="display:none">
        <table id="clients-table" aria-label="Clients"></table>
      </div>
    </section>

    <!-- Placeholder Panels -->
    <section class="panel" id="panel-payments" style="display:none"><div class="muted">Payments tab placeholder.</div></section>
    <section class="panel" id="panel-groups" style="display:none"><div class="muted">Groups tab placeholder.</div></section>
    <section class="panel" id="panel-roi" style="display:none"><div class="muted">Group ROI tab placeholder.</div></section>
  </main>

  <!-- Add Client Modal -->
  <div class="modal-backdrop" id="add-modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <div class="brand">Add Client</div>
        <button class="btn" id="btn-close-x" aria-label="Close">✕</button>
      </header>
      <div class="content">
        <form id="add-client-form" autocomplete="off">
          <div class="row">
            <div class="grow">
              <div class="label">First Name</div>
              <input class="input" name="first_name" required />
            </div>
            <div class="grow">
              <div class="label">Last Name</div>
              <input class="input" name="last_name" required />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <div class="label">Email</div>
              <input class="input" type="email" name="email" />
            </div>
            <div class="grow">
              <div class="label">Phone</div>
              <input class="input" name="phone" placeholder="+15555550123" />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <div class="label">Referred By (optional — type at least 2 characters)</div>
              <div class="ac-wrap">
                <input class="input" id="ref-search" placeholder="e.g., Smith, Jane  or  jane@company.com" />
                <div class="ac-list" id="ref-list"></div>
              </div>
              <!-- Hidden fields sent to Worker -->
              <input type="hidden" name="referred_by_id" id="ref-ghl-id" />
              <input type="hidden" name="referred_by_first_name" id="ref-first" />
              <input type="hidden" name="referred_by_last_name" id="ref-last" />

              <div id="ref-pill" style="margin-top:8px; display:none;" class="pill">
                <span id="ref-pill-text"></span>
                <span class="x" id="ref-pill-x">✕</span>
              </div>
              <div class="muted" style="margin-top:6px; display:flex; gap:10px; align-items:center;">
                <button type="button" class="btn small" id="ref-skip">Skip referrer</button>
              </div>
            </div>
          </div>

          <div id="form-msg" class="muted" style="margin-top:10px"></div>
        </form>
      </div>
      <footer>
        <button class="btn" id="btn-cancel">Cancel</button>
        <button class="btn primary" id="btn-save">Save Client</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Config: Worker base URLs =====
    const API_BASE_ADD     = 'https://snf-add-client.dennis-e64.workers.dev';
    const API_BASE_SEARCH  = 'https://snf-search-contacts.dennis-e64.workers.dev';
    const API_BASE_LIST    = 'https://snf-list-clients.dennis-e64.workers.dev';
    const CLIENTS_LIST_PATH = '/';

    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      clients: document.getElementById('panel-clients'),
      payments: document.getElementById('panel-payments'),
      groups: document.getElementById('panel-groups'),
      roi: document.getElementById('panel-roi'),
    };
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      Object.values(panels).forEach(p => p.style.display='none');
      panels[t.dataset.tab].style.display = '';
    }));

    // ===== Modal helpers =====
    const modalBackdrop = document.getElementById('add-modal-backdrop');
    const openModal = () => { modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); };
    const closeModal = () => { modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); resetForm(); };
    document.getElementById('btn-add-client').onclick = openModal;
    document.getElementById('btn-cancel').onclick = closeModal;
    document.getElementById('btn-close-x').onclick = closeModal;
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal(); });

    // ===== Referral search =====
    const refInput   = document.getElementById('ref-search');
    const refList    = document.getElementById('ref-list');
    const refGhlId   = document.getElementById('ref-ghl-id');
    const refFirst   = document.getElementById('ref-first');
    const refLast    = document.getElementById('ref-last');
    const refPill    = document.getElementById('ref-pill');
    const refPillText= document.getElementById('ref-pill-text');
    const refPillX   = document.getElementById('ref-pill-x');
    const refSkip    = document.getElementById('ref-skip');
    const formMsg    = document.getElementById('form-msg');

    let acTimer = null;
    refInput.addEventListener('input', () => {
      const q = refInput.value.trim();
      if (acTimer) clearTimeout(acTimer);
      if (q.length < 2) { refList.style.display='none'; return; }
      acTimer = setTimeout(async () => { await loadContactMatches(q); }, 250);
    });

    refPillX.addEventListener('click', clearReferrer);
    refSkip.addEventListener('click', clearReferrer);

    function clearReferrer(){
      refGhlId.value = '';
      refFirst.value = '';
      refLast.value = '';
      refPill.style.display = 'none';
      refList.style.display = 'none';
      refInput.value = '';
      refInput.blur();
    }

    async function loadContactMatches(q) {
      refList.innerHTML = '<div class="ac-item muted">Searching…</div>';
      refList.style.display = 'block';
      try {
        const url = new URL('/snf-search-contacts', API_BASE_SEARCH);
        url.searchParams.set('q', q);
        url.searchParams.set('limit', '10');

        const res = await fetch(url.toString(), { method: 'GET', headers: { 'Accept': 'application/json' } });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || txt || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        if (!rows.length) {
          refList.innerHTML = '<div class="ac-item muted">No matches</div>';
          return;
        }
        rows.sort((a,b) => {
          const la = (a.last_name || '').toLowerCase();
          const lb = (b.last_name || '').toLowerCase();
          if (la !== lb) return la < lb ? -1 : 1;
          const fa = (a.first_name || '').toLowerCase();
          const fb = (b.first_name || '').toLowerCase();
          return fa < fb ? -1 : (fa > fb ? 1 : 0);
        });

        refList.innerHTML = '';
        rows.forEach(r => {
          const div = document.createElement('div');
          const label = `${(r.last_name||'').trim()}, ${(r.first_name||'').trim()} — ${r.email||'no email'}`;
          div.className = 'ac-item';
          div.textContent = label;
          div.onclick = () => {
            refGhlId.value = r.ghl_id || r.id || '';
            refFirst.value = r.first_name || '';
            refLast.value  = r.last_name || '';
            refPillText.textContent = label;
            refPill.style.display = 'inline-flex';
            refList.style.display = 'none';
            refInput.value = '';
          };
          refList.appendChild(div);
        });
      } catch (e) {
        refList.innerHTML = `<div class="ac-item" style="color:var(--danger)">Search error: ${e.message}</div>`;
      }
    }

    // ===== Save Client =====
    document.getElementById('btn-save').addEventListener('click', async () => {
      const form = document.getElementById('add-client-form');
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      const missing = ['first_name','last_name'].filter(k => !payload[k]?.trim());
      if (missing.length) return setMsg('Please fill in First Name and Last Name.', true);

      try {
        setMsg('Saving…');
        const res = await fetch(`${API_BASE_ADD}/snf-add-client`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || (txt && txt.trim()) || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        setMsg('Client added successfully!', false, true);
        setTimeout(() => { closeModal(); loadClients(); }, 600);
      } catch (e) {
        setMsg(e.message || 'Save failed', true);
      }
    });

    function setMsg(text, isError=false, isSuccess=false){
      formMsg.className = isError ? 'error' : (isSuccess ? 'success' : 'muted');
      formMsg.textContent = text;
    }
    function resetForm(){
      document.getElementById('add-client-form').reset();
      clearReferrer();
      setMsg('', false);
    }

    // ===== Clients list =====
    const clientsStatus = document.getElementById('clients-status');
    const clientsTableWrap = document.getElementById('clients-table-wrap');
    const clientsTable = document.getElementById('clients-table');
    document.getElementById('btn-refresh-clients').addEventListener('click', loadClients);

    async function loadClients(){
      clientsStatus.textContent = 'Loading clients…';
      clientsTableWrap.style.display = 'none';
      clientsTable.innerHTML = '';
      try {
        const url = new URL(CLIENTS_LIST_PATH, API_BASE_LIST);
        const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || text || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        clientsStatus.textContent = rows.length ? `Loaded ${rows.length} client${rows.length===1?'':'s'}.` : 'No clients found.';
        if (!rows.length) return;

        renderClientsTable(rows);
        clientsTableWrap.style.display = '';
      } catch (err){
        clientsStatus.textContent = `Error loading clients: ${err.message}`;
      }
    }

    function renderClientsTable(rows){
      // Preferred columns (no IDs; referral names only)
      const preferred = [
        'first_name','last_name',
        'email','phone',
        'referred_by_first_name','referred_by_last_name',
        'created_at','updated_at'
      ];
      // Always hide these
      const HIDE = new Set(['id','client_id','referred_by_id']);

      // Gather keys
      const keySet = new Set();
      rows.forEach(r => Object.keys(r || {}).forEach(k => { if (!HIDE.has(k)) keySet.add(k); }));

      const allKeys = Array.from(keySet);
      const ordered = [
        ...preferred.filter(k => keySet.has(k)),
        ...allKeys.filter(k => !preferred.includes(k)).sort((a,b)=> a.localeCompare(b))
      ];

      // Build table
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ordered.forEach(k => {
        const th = document.createElement('th');
        th.textContent = prettifyHeader(k);
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        ordered.forEach(k => {
          const td = document.createElement('td');
          let v = r[k];
          if (v === null || v === undefined) v = '';
          if (Array.isArray(v)) v = v.join(', ');
          if (typeof v === 'object' && v) v = JSON.stringify(v);
          td.textContent = String(v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      clientsTable.innerHTML = '';
      clientsTable.appendChild(thead);
      clientsTable.appendChild(tbody);
    }

    function prettifyHeader(k){
      return k
        .replace(/_/g,' ')
        .replace(/\b(id)\b/i, 'ID')
        .replace(/\b(ghl)\b/i, 'GHL')
        .replace(/\b([a-z])/g, (m)=>m.toUpperCase());
    }

    // Initial load
    loadClients();
  </script>
</body>
</html>
