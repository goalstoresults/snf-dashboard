<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SNF Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7fafc; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .brand{font-weight:700}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;padding:10px 20px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;background:#fdfdfd;
      border-top-left-radius:10px;border-top-right-radius:10px;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--card);color:var(--text);font-weight:600}
    main{padding:18px 20px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .row-nowrap{display:flex;flex-wrap:nowrap;gap:12px;align-items:flex-end}
    .grow{flex:1 1 220px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.small{padding:6px 10px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .modal{background:#fff;border-radius:16px;max-width:680px;width:100%;border:1px solid var(--border);box-shadow:0 8px 28px rgba(0,0,0,.15)}
    .modal header{border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .modal .content{padding:16px}
    /* Tables */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:#fff}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--border);text-align:left;font-weight:600;padding:10px;white-space:nowrap}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top;white-space:nowrap}
    tbody tr:nth-child(even){background:#fcfcfd}
    .empty{padding:10px;color:var(--muted)}
    /* Sortable headers (Groups tab) */
    th.sortable { cursor:pointer; user-select:none; }
    th.sortable .hdr { display:flex; align-items:center; gap:6px; }
    th.sortable .arrow { font-size:11px; color:var(--muted); }
    th.sortable.active { color:var(--text); }
    th.sortable.active .arrow { color:var(--text); }
    /* Compact filter line on ROI */
    .filter-item{min-width:220px}
    .filter-actions{display:flex;gap:8px;align-items:flex-end}
    @media (max-width:780px){
      .row-nowrap{flex-wrap:wrap}
      .filter-item{min-width:160px}
    }
    #version{font-size:12px;color:var(--muted)}
    .error{color:var(--danger);font-size:12px;margin-top:6px}
    .success{color:var(--accent-2);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">SNF Dashboard</div>
    <div id="version">SNF UI v0.20</div>
  </header>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="clients">Clients</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="groups">Groups</div>
    <div class="tab" data-tab="roi">Group ROI</div>
  </div>

  <main>
    <!-- Clients Panel -->
    <section class="panel" id="panel-clients">
      <div class="toolbar">
        <div><strong>Clients</strong> <span class="muted">— add and manage clients</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-clients">Refresh</button>
          <button class="btn primary" id="btn-add-client">+ Add Client</button>
        </div>
      </div>

      <div id="clients-status" class="muted" style="margin-bottom:8px">Loading clients…</div>
      <div class="table-wrap" id="clients-table-wrap" style="display:none">
        <table id="clients-table" aria-label="Clients"></table>
      </div>
    </section>

    <!-- Payments (placeholder) -->
    <section class="panel" id="panel-payments" style="display:none">
      <div class="muted">Payments tab placeholder.</div>
    </section>

    <!-- Groups Panel -->
    <section class="panel" id="panel-groups" style="display:none">
      <div class="toolbar">
        <div><strong>Groups</strong> <span class="muted">— list and add groups</span></div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn" id="btn-refresh-groups">Refresh</button>
          <button class="btn primary" id="btn-toggle-add-group" aria-pressed="false">+ Add Group</button>
        </div>
      </div>

      <!-- Add Group inline form -->
      <div id="group-form-wrap" style="display:none; margin-bottom:12px;">
        <div class="row">
          <div class="grow">
            <div class="label">Year</div>
            <select class="input" id="grp-year"></select>
          </div>
          <div class="grow">
            <div class="label">Group Name</div>
            <input class="input" id="grp-name" placeholder="e.g., Spring 2025" />
          </div>
          <div class="grow">
            <div class="label">Date Started</div>
            <input class="input" id="grp-date" type="date" />
          </div>
          <div class="grow">
            <div class="label">Total Amount</div>
            <input class="input" id="grp-amount" type="number" step="0.01" placeholder="0.00" />
          </div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button class="btn" id="btn-cancel-group" style="display:none">Cancel</button>
          <button class="btn primary" id="btn-save-group">Save Group</button>
        </div>
        <div id="group-form-msg" class="muted" style="margin-top:8px;"></div>
        <hr style="margin:16px 0;border:none;border-top:1px solid var(--border);" />
      </div>

      <div class="table-wrap">
        <table id="groups-table" aria-label="Groups">
          <thead>
            <tr>
              <th class="sortable" data-col="group_name"><span class="hdr">Group Name <span class="arrow">▲▼</span></span></th>
              <th class="sortable" data-col="total_amount"><span class="hdr">Total Amount <span class="arrow">▲▼</span></span></th>
              <th class="sortable" data-col="total_referral_amount"><span class="hdr">Total Referral Amount <span class="arrow">▲▼</span></span></th>
              <th class="sortable" data-col="total_roi"><span class="hdr">Total ROI <span class="arrow">▲▼</span></span></th>
              <th class="sortable" data-col="date_started"><span class="hdr">Date Started <span class="arrow">▲▼</span></span></th>
            </tr>
          </thead>
          <tbody id="groups-tbody">
            <tr><td class="empty" colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Group ROI Panel -->
    <section class="panel" id="panel-roi" style="display:none">
      <div class="toolbar">
        <div><strong>Group ROI</strong> <span class="muted">— filter by Group and Year</span></div>
        <div class="row-nowrap" style="gap:10px">
          <div class="filter-item">
            <div class="label">Group Name</div>
            <select class="input" id="roi-filter-group">
              <option value="ALL">ALL</option>
            </select>
          </div>
          <div class="filter-item">
            <div class="label">Year</div>
            <select class="input" id="roi-filter-year">
              <option value="ALL">ALL</option>
            </select>
          </div>
          <div class="filter-actions">
            <button class="btn primary" id="btn-load-roi">Load</button>
            <button class="btn" id="btn-retry-roi" style="display:none">Retry</button>
          </div>
        </div>
      </div>

      <div id="roi-status" class="muted" style="margin-bottom:8px">Loading ROI…</div>
      <div class="table-wrap">
        <table id="roi-table" aria-label="Group ROI">
          <thead>
            <tr>
              <th>Group Name</th>
              <th>Year</th>
              <th>Renewal Date</th>
              <th>Renewal Amount</th>
              <th>Referral Amount</th>
              <th>ROI</th>
            </tr>
          </thead>
          <tbody id="roi-tbody">
            <tr><td class="empty" colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Add Client Modal -->
  <div class="modal-backdrop" id="add-modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>
        <div class="brand">Add Client</div>
        <button class="btn" id="btn-close-x" aria-label="Close">✕</button>
      </header>
      <div class="content">
        <form id="add-client-form" autocomplete="off">
          <div class="row">
            <div class="grow">
              <div class="label">First Name</div>
              <input class="input" name="first_name" required />
            </div>
            <div class="grow">
              <div class="label">Last Name</div>
              <input class="input" name="last_name" required />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <div class="label">Email</div>
              <input class="input" type="email" name="email" />
            </div>
            <div class="grow">
              <div class="label">Phone</div>
              <input class="input" name="phone" placeholder="+15555550123" />
            </div>
          </div>
          <div class="row">
            <div class="grow">
              <div class="label">Referred By (optional — type at least 2 characters)</div>
              <div class="ac-wrap">
                <input class="input" id="ref-search" placeholder="e.g., Smith, Jane  or  jane@company.com" />
                <div class="ac-list" id="ref-list"></div>
              </div>
              <input type="hidden" name="referred_by_id" id="ref-ghl-id" />
              <input type="hidden" name="referred_by_first_name" id="ref-first" />
              <input type="hidden" name="referred_by_last_name" id="ref-last" />
              <div id="ref-pill" style="margin-top:8px; display:none;" class="pill">
                <span id="ref-pill-text"></span>
                <span class="x" id="ref-pill-x">✕</span>
              </div>
              <div class="muted" style="margin-top:6px; display:flex; gap:10px; align-items:center;">
                <button type="button" class="btn small" id="ref-skip">Skip referrer</button>
              </div>
            </div>
          </div>
          <div id="form-msg" class="muted" style="margin-top:10px"></div>
        </form>
      </div>
      <footer>
        <button class="btn" id="btn-cancel">Cancel</button>
        <button class="btn primary" id="btn-save">Save Client</button>
      </footer>
    </div>
  </div>

  <script>
    // ===== Worker base URLs =====
    const API_BASE_ADD     = 'https://snf-add-client.dennis-e64.workers.dev';
    const API_BASE_SEARCH  = 'https://snf-search-contacts.dennis-e64.workers.dev';
    const API_BASE_LIST    = 'https://snf-list-clients.dennis-e64.workers.dev';
    const CLIENTS_LIST_PATH = '/';

    const GROUPS_LIST_URL  = 'https://snf-list-groups.dennis-e64.workers.dev';
    const GROUPS_ADD_URL   = 'https://snf-add-group.dennis-e64.workers.dev';

    // ROI list (returns rows + distincts; supports ?group_name=&year=)
    const ROI_LIST_URL     = 'https://snf-list-group-roi.dennis-e64.workers.dev/';

    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      clients: document.getElementById('panel-clients'),
      payments: document.getElementById('panel-payments'),
      groups: document.getElementById('panel-groups'),
      roi: document.getElementById('panel-roi'),
    };
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      Object.values(panels).forEach(p => p.style.display='none');
      const which = t.dataset.tab;
      panels[which].style.display = '';
      if (which === 'clients') loadClients();
      if (which === 'groups')  loadGroups();
      if (which === 'roi')     initAndLoadROI();
    }));

    // ===== Clients =====
    const modalBackdrop = document.getElementById('add-modal-backdrop');
    const openModal = () => { modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); };
    const closeModal = () => { modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); resetForm(); };
    document.getElementById('btn-add-client').onclick = openModal;
    document.getElementById('btn-cancel').onclick = closeModal;
    document.getElementById('btn-close-x').onclick = closeModal;
    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal(); });

    const refInput   = document.getElementById('ref-search');
    const refList    = document.getElementById('ref-list');
    const refGhlId   = document.getElementById('ref-ghl-id');
    const refFirst   = document.getElementById('ref-first');
    const refLast    = document.getElementById('ref-last');
    const refPill    = document.getElementById('ref-pill');
    const refPillText= document.getElementById('ref-pill-text');
    const refPillX   = document.getElementById('ref-pill-x');
    const refSkip    = document.getElementById('ref-skip');
    const formMsg    = document.getElementById('form-msg');

    let acTimer = null;
    refInput.addEventListener('input', () => {
      const q = refInput.value.trim();
      if (acTimer) clearTimeout(acTimer);
      if (q.length < 2) { refList.style.display='none'; return; }
      acTimer = setTimeout(async () => { await loadContactMatches(q); }, 250);
    });
    refPillX.addEventListener('click', clearReferrer);
    refSkip.addEventListener('click', clearReferrer);

    function clearReferrer(){
      refGhlId.value = '';
      refFirst.value = '';
      refLast.value = '';
      refPill.style.display = 'none';
      refList.style.display = 'none';
      refInput.value = '';
      refInput.blur();
    }

    async function loadContactMatches(q) {
      refList.innerHTML = '<div class="ac-item muted">Searching…</div>';
      refList.style.display = 'block';
      try {
        const url = new URL('/snf-search-contacts', API_BASE_SEARCH);
        url.searchParams.set('q', q);
        url.searchParams.set('limit', '10');

        const res = await fetch(url.toString(), { method: 'GET', headers: { 'Accept': 'application/json' } });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || txt || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        if (!rows.length) {
          refList.innerHTML = '<div class="ac-item muted">No matches</div>';
          return;
        }
        rows.sort((a,b) => {
          const la = (a.last_name || '').toLowerCase();
          const lb = (b.last_name || '').toLowerCase();
          if (la !== lb) return la < lb ? -1 : 1;
          const fa = (a.first_name || '').toLowerCase();
          const fb = (b.first_name || '').toLowerCase();
          return fa < fb ? -1 : (fa > fb ? 1 : 0);
        });

        refList.innerHTML = '';
        rows.forEach(r => {
          const div = document.createElement('div');
          const label = `${(r.last_name||'').trim()}, ${(r.first_name||'').trim()} — ${r.email||'no email'}`;
          div.className = 'ac-item';
          div.textContent = label;
          div.onclick = () => {
            refGhlId.value = r.ghl_id || r.id || '';
            refFirst.value = r.first_name || '';
            refLast.value  = r.last_name || '';
            refPillText.textContent = label;
            refPill.style.display = 'inline-flex';
            refList.style.display = 'none';
            refInput.value = '';
          };
          refList.appendChild(div);
        });
      } catch (e) {
        refList.innerHTML = `<div class="ac-item" style="color:var(--danger)">Search error: ${e.message}</div>`;
      }
    }

    document.getElementById('btn-save').addEventListener('click', async () => {
      const form = document.getElementById('add-client-form');
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      const missing = ['first_name','last_name'].filter(k => !payload[k]?.trim());
      if (missing.length) return setMsg('Please fill in First Name and Last Name.', true);

      try {
        setMsg('Saving…');
        const res = await fetch(`${API_BASE_ADD}/snf-add-client`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        let data = null; try { data = JSON.parse(txt); } catch {}
        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || (txt && txt.trim()) || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        setMsg('Client added successfully!', false, true);
        setTimeout(() => { closeModal(); loadClients(); }, 600);
      } catch (e) {
        setMsg(e.message || 'Save failed', true);
      }
    });

    function setMsg(text, isError=false, isSuccess=false){
      formMsg.className = isError ? 'error' : (isSuccess ? 'success' : 'muted');
      formMsg.textContent = text;
    }
    function resetForm(){
      document.getElementById('add-client-form').reset();
      clearReferrer();
      setMsg('', false);
    }

    const clientsStatus = document.getElementById('clients-status');
    const clientsTableWrap = document.getElementById('clients-table-wrap');
    const clientsTable = document.getElementById('clients-table');
    document.getElementById('btn-refresh-clients').addEventListener('click', loadClients);

    async function loadClients(){
      clientsStatus.textContent = 'Loading clients…';
      clientsTableWrap.style.display = 'none';
      clientsTable.innerHTML = '';
      try {
        const url = new URL(CLIENTS_LIST_PATH, API_BASE_LIST);
        const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch {}
        if (!res.ok) throw new Error((data && (data.error || data.message)) || text || `HTTP ${res.status}`);

        const rows = (data && data.rows) || [];
        clientsStatus.textContent = rows.length ? `Loaded ${rows.length} client${rows.length===1?'':'s'}.` : 'No clients found.';
        if (!rows.length) return;

        renderClientsTable(rows);
        clientsTableWrap.style.display = '';
      } catch (err){
        clientsStatus.textContent = `Error loading clients: ${err.message}`;
      }
    }

    function renderClientsTable(rows){
      const preferred = [
        'first_name','last_name',
        'email','phone',
        'referred_by_first_name','referred_by_last_name',
        'created_at','updated_at'
      ];
      const HIDE = new Set(['id','client_id','referred_by_id']);

      const keySet = new Set();
      rows.forEach(r => Object.keys(r || {}).forEach(k => { if (!HIDE.has(k)) keySet.add(k); }));

      const allKeys = Array.from(keySet);
      const ordered = [
        ...preferred.filter(k => keySet.has(k)),
        ...allKeys.filter(k => !preferred.includes(k)).sort((a,b)=> a.localeCompare(b))
      ];

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ordered.forEach(k => {
        const th = document.createElement('th');
        th.textContent = prettifyHeader(k);
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        ordered.forEach(k => {
          const td = document.createElement('td');
          let v = r[k];
          if (v === null || v === undefined) v = '';
          if (Array.isArray(v)) v = v.join(', ');
          if (typeof v === 'object' && v) v = JSON.stringify(v);
          td.textContent = String(v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      clientsTable.innerHTML = '';
      clientsTable.appendChild(thead);
      clientsTable.appendChild(tbody);
    }

    function prettifyHeader(k){
      return k
        .replace(/_/g,' ')
        .replace(/\b(id)\b/i, 'ID')
        .replace(/\b(ghl)\b/i, 'GHL')
        .replace(/\b([a-z])/g, (m)=>m.toUpperCase());
    }

    // ===== Groups (sortable) =====
    const groupsTbody       = document.getElementById('groups-tbody');
    const btnToggleAddGroup = document.getElementById('btn-toggle-add-group');
    const btnRefreshGroups  = document.getElementById('btn-refresh-groups');
    const grpFormWrap       = document.getElementById('group-form-wrap');
    const grpYear   = document.getElementById('grp-year');
    const grpName   = document.getElementById('grp-name');
    const grpDate   = document.getElementById('grp-date');
    const grpAmount = document.getElementById('grp-amount');
    const grpMsg    = document.getElementById('group-form-msg');

    let groupsData = []; // cache
    let groupSort = { col: 'group_name', dir: 'asc' }; // default

    function setAddGroupButtonState(open){
      const btn = btnToggleAddGroup;
      btn.setAttribute('aria-pressed', open ? 'true' : 'false');
      if (open) {
        btn.textContent = 'Cancel Add';
        btn.classList.remove('primary');
      } else {
        btn.textContent = '+ Add Group';
        btn.classList.add('primary');
      }
    }
    function showGroupForm(open){
      if (open) {
        grpFormWrap.style.display = 'block';
        grpMsg.textContent = '';
      } else {
        grpFormWrap.style.display = 'none';
        grpMsg.textContent = '';
        grpName.value=''; grpDate.value=''; grpAmount.value='';
      }
      setAddGroupButtonState(open);
    }

    btnToggleAddGroup.addEventListener('click', () => {
      const open = grpFormWrap.style.display !== 'block';
      showGroupForm(open);
    });
    document.getElementById('btn-cancel-group').addEventListener('click', (e) => {
      e.preventDefault();
      showGroupForm(false);
    });

    // Year dropdown: 2025..2034
    (function initYears(){
      for(let y=2025; y<2025+10; y++){
        const o=document.createElement('option');
        o.value=y; o.textContent=y;
        grpYear.appendChild(o);
      }
    })();

    btnRefreshGroups.addEventListener('click', loadGroups);
    document.getElementById('btn-save-group').addEventListener('click', submitAddGroup);

    async function loadGroups(){
      groupsTbody.innerHTML = `<tr><td class="empty" colspan="5">Loading…</td></tr>`;
      try{
        const r = await fetch(GROUPS_LIST_URL, {
          method:'GET',
          headers:{Accept:'application/json'},
          cache:'no-store',
          mode:'cors'
        });
        const raw = await r.text();
        let d = null; try { d = JSON.parse(raw); } catch {}

        if (!r.ok) {
          const msg = d?.error || d?.message || raw || `HTTP ${r.status}`;
          groupsTbody.innerHTML = `<tr><td class="empty" colspan="5" style="color:var(--danger)">Error: ${esc(msg)}</td></tr>`;
          console.error('GROUPS LIST ERROR', { status:r.status, raw, json:d });
          return;
        }

        groupsData = Array.isArray(d?.rows) ? d.rows : [];
        renderGroupsTable();
        wireGroupHeaderClicks();
      }catch(e){
        groupsTbody.innerHTML = `<tr><td class="empty" colspan="5" style="color:var(--danger)">Error: ${esc(e.message||String(e))}</td></tr>`;
        console.error('GROUPS LIST EXCEPTION', e);
      }
    }

    function wireGroupHeaderClicks(){
      const ths = document.querySelectorAll('#groups-table thead th.sortable');
      ths.forEach(th => {
        th.onclick = () => {
          const col = th.getAttribute('data-col');
          if (!col) return;
          if (groupSort.col === col) {
            groupSort.dir = (groupSort.dir === 'asc') ? 'desc' : 'asc';
          } else {
            groupSort.col = col;
            groupSort.dir = 'asc';
          }
          renderGroupsTable();
        };
      });
    }

    function renderGroupsTable(){
      const rows = [...groupsData].sort((a,b) => compareGroupRows(a,b, groupSort.col, groupSort.dir));
      if (!rows.length){
        groupsTbody.innerHTML = `<tr><td class="empty" colspan="5">No groups found.</td></tr>`;
      } else {
        groupsTbody.innerHTML = rows.map(g => `
          <tr>
            <td>${esc(g.group_name||'')}</td>
            <td>${fmtMoneyUSD(g.total_amount)}</td>
            <td>${fmtMoneyUSD(g.total_referral_amount)}</td>
            <td>${fmtPercent(g.total_roi)}</td>
            <td>${esc(g.date_started||'')}</td>
          </tr>
        `).join('');
      }
      updateGroupHeaderArrows();
    }

    function updateGroupHeaderArrows(){
      const ths = document.querySelectorAll('#groups-table thead th.sortable');
      ths.forEach(th => {
        const col = th.getAttribute('data-col');
        const arrow = th.querySelector('.arrow');
        th.classList.toggle('active', col === groupSort.col);
        if (arrow) {
          if (col === groupSort.col) {
            arrow.textContent = groupSort.dir === 'asc' ? '▲' : '▼';
          } else {
            arrow.textContent = '▲▼';
          }
        }
      });
    }

    function compareGroupRows(a, b, col, dir){
      const mul = dir === 'desc' ? -1 : 1;
      const va = (a?.[col]);
      const vb = (b?.[col]);

      if (['total_amount','total_referral_amount','total_roi'].includes(col)) {
        const na = Number(va) || 0;
        const nb = Number(vb) || 0;
        return (na < nb ? -1 : na > nb ? 1 : 0) * mul;
      }

      if (col === 'date_started') {
        const sa = (typeof va === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(va)) ? va : '';
        const sb = (typeof vb === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(vb)) ? vb : '';
        if (sa === sb) return 0;
        return (sa < sb ? -1 : 1) * mul; // ISO date lexical compare
      }

      const sa = (va ?? '').toString().toLowerCase();
      const sb = (vb ?? '').toString().toLowerCase();
      if (sa === sb) return 0;
      return (sa < sb ? -1 : 1) * mul;
    }

    async function submitAddGroup(){
      grpMsg.className='muted';
      grpMsg.textContent='Saving…';

      const payload = {
        year: Number(grpYear.value),
        group_name: (grpName.value||'').trim(),
        date_started: grpDate.value || null,
        total_amount: grpAmount.value === '' ? 0 : Number(grpAmount.value)
      };

      if(!payload.group_name){ grpMsg.className='error'; grpMsg.textContent='Please enter a Group Name.'; return; }
      if(!Number.isInteger(payload.year)){ grpMsg.className='error'; grpMsg.textContent='Select a valid Year.'; return; }
      if(payload.date_started && !/^\d{4}-\d{2}-\d{2}$/.test(payload.date_started)){
        grpMsg.className='error'; grpMsg.textContent='Date must be YYYY-MM-DD.'; return;
      }
      if(!Number.isFinite(payload.total_amount)){
        grpMsg.className='error'; grpMsg.textContent='Total Amount must be numeric.'; return;
      }

      try{
        const r = await fetch(GROUPS_ADD_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload),
          cache:'no-store',
          mode:'cors'
        });

        const raw = await r.text();
        let d = null; try { d = JSON.parse(raw); } catch {}

        if (!r.ok || !d?.ok) {
          const msg = (d?.error || d?.detail || d?.message || raw || `HTTP ${r.status}`);
          grpMsg.className='error';
          grpMsg.innerHTML = `Save failed: ${esc(msg)}<br><span class="muted">Check console for payload/response debug.</span>`;
          console.error('GROUPS ADD ERROR', {
            status: r.status,
            requestPayload: payload,
            responseRaw: raw,
            responseJson: d
          });
          return;
        }

        grpMsg.className='success';
        grpMsg.textContent='Saved!';
        await loadGroups();

        // Close form and return focus to Add button for rapid entry
        showGroupForm(false);
        document.getElementById('btn-toggle-add-group')?.focus();

      }catch(e){
        grpMsg.className='error';
        grpMsg.innerHTML = `Network/JS error: ${esc(e.message||String(e))}<br><span class="muted">See console for details.</span>`;
        console.error('GROUPS ADD EXCEPTION', e, { requestPayload: payload });
      }
    }

    // ===== Group ROI (server-side filtering) =====
    const roiStatus = document.getElementById('roi-status');
    const roiTbody  = document.getElementById('roi-tbody');
    const roiFilterGroup = document.getElementById('roi-filter-group');
    const roiFilterYear  = document.getElementById('roi-filter-year');
    const btnLoadRoi     = document.getElementById('btn-load-roi');
    const btnRetryRoi    = document.getElementById('btn-retry-roi');

    let roiDistinctLoaded = false;

    async function initAndLoadROI(){
      if (!roiDistinctLoaded) {
        await fetchRoiDistinctsAndInitialRows();
        roiDistinctLoaded = true;
      } else {
        await loadRoiRowsFromFilters(); // keep fresh if user returns
      }
    }

    async function fetchRoiDistinctsAndInitialRows(){
      roiStatus.textContent = 'Loading ROI…';
      roiTbody.innerHTML = `<tr><td class="empty" colspan="6">Loading…</td></tr>`;
      btnRetryRoi.style.display = 'none';
      try{
        // First call without filters to get rows + distincts
        const res = await fetch(ROI_LIST_URL, {
          method:'GET',
          headers:{Accept:'application/json'},
          cache:'no-store',
          mode:'cors'
        });
        const raw = await res.text(); let data = null; try { data = JSON.parse(raw); } catch {}
        if (!res.ok) {
          const msg = (data?.error || data?.message || raw || `HTTP ${res.status}`);
          roiStatus.textContent = `Error fetching ROI: ${msg}`;
          roiTbody.innerHTML = `<tr><td class="empty" colspan="6" style="color:var(--danger)">Error: ${esc(msg)}</td></tr>`;
          btnRetryRoi.style.display = '';
          console.error('ROI LIST ERROR', { status: res.status, raw, json: data });
          return;
        }
        populateRoiFilters(data?.distinct);
        renderRoiTableRows(Array.isArray(data?.rows) ? data.rows : []);
      }catch(e){
        roiStatus.textContent = `Network/JS error: ${e.message||String(e)}`;
        roiTbody.innerHTML = `<tr><td class="empty" colspan="6" style="color:var(--danger)">Network/JS error: ${esc(e.message||String(e))}</td></tr>`;
        btnRetryRoi.style.display = '';
        console.error('ROI LIST EXCEPTION', e);
      }
    }

    function populateRoiFilters(distinct){
      const groups = (distinct?.group_names || []).slice();
      const years  = (distinct?.years || []).slice();

      roiFilterGroup.innerHTML = '<option value="ALL">ALL</option>';
      groups.forEach(g => { const o=document.createElement('option'); o.value=g; o.textContent=g; roiFilterGroup.appendChild(o); });

      roiFilterYear.innerHTML = '<option value="ALL">ALL</option>';
      years.forEach(y => { const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); roiFilterYear.appendChild(o); });

      roiFilterGroup.value = 'ALL';
      roiFilterYear.value  = 'ALL';
    }

    async function loadRoiRowsFromFilters(){
      const group = roiFilterGroup.value;
      const year  = roiFilterYear.value;

      roiStatus.textContent = 'Loading…';
      roiTbody.innerHTML = `<tr><td class="empty" colspan="6">Loading…</td></tr>`;
      btnRetryRoi.style.display = 'none';

      try{
        // Build URL with server-side filters
        const u = new URL(ROI_LIST_URL);
        if (group && group !== 'ALL') u.searchParams.set('group_name', group);
        if (year && year !== 'ALL')   u.searchParams.set('year', year);

        const res = await fetch(u.toString(), {
          method:'GET',
          headers:{Accept:'application/json'},
          cache:'no-store',
          mode:'cors'
        });

        const raw = await res.text(); let data = null; try { data = JSON.parse(raw); } catch {}
        if (!res.ok) {
          const msg = (data?.error || data?.message || raw || `HTTP ${res.status}`);
          roiStatus.textContent = `Error fetching ROI: ${msg}`;
          roiTbody.innerHTML = `<tr><td class="empty" colspan="6" style="color:var(--danger)">Error: ${esc(msg)}</td></tr>`;
          btnRetryRoi.style.display = '';
          console.error('ROI FILTER ERROR', { status: res.status, raw, json: data, group, year });
          return;
        }

        renderRoiTableRows(Array.isArray(data?.rows) ? data.rows : []);
      }catch(e){
        roiStatus.textContent = `Network/JS error: ${e.message||String(e)}`;
        roiTbody.innerHTML = `<tr><td class="empty" colspan="6" style="color:var(--danger)">Network/JS error: ${esc(e.message||String(e))}</td></tr>`;
        btnRetryRoi.style.display = '';
        console.error('ROI FILTER EXCEPTION', e);
      }
    }

    function renderRoiTableRows(rows){
      roiStatus.textContent = rows.length ? `Loaded ${rows.length} record${rows.length===1?'':'s'}.` : 'No records found.';
      if (!rows.length) {
        roiTbody.innerHTML = `<tr><td class="empty" colspan="6">No records found.</td></tr>`;
        return;
      }
      roiTbody.innerHTML = rows.map(r => `
        <tr>
          <td>${esc(r.group_name||'')}</td>
          <td>${esc(r.year ?? '')}</td>
          <td>${esc(r.renewal_date||'')}</td>
          <td>${fmtMoneyUSD(r.renewal_amount)}</td>
          <td>${fmtMoneyUSD(r.referral_amount)}</td>
          <td>${fmtPercent(r.roi)}</td>
        </tr>
      `).join('');
    }

    document.getElementById('btn-load-roi').addEventListener('click', loadRoiRowsFromFilters);
    btnRetryRoi.addEventListener('click', fetchRoiDistinctsAndInitialRows);

    // ---- formatters / utils ----
    const usdFmt = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2, maximumFractionDigits:2 });
    function fmtMoneyUSD(v){
      if(v==null || v==='') return '';
      const n = Number(v);
      return Number.isFinite(n) ? usdFmt.format(n) : '';
    }
    const pctIntl = new Intl.NumberFormat('en-US', { style:'percent', minimumFractionDigits:2, maximumFractionDigits:2 });
    function fmtPercent(v){
      if(v==null || v==='') return '';
      const n = Number(v);
      if(!Number.isFinite(n)) return '';
      // Accept 0–1 (fraction) or 0–100 (percent)
      if (Math.abs(n) <= 1) return pctIntl.format(n);
      return `${n.toFixed(2)}%`;
    }
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ===== Init =====
    document.getElementById('btn-refresh-clients').addEventListener('click', loadClients);
    document.getElementById('btn-refresh-groups').addEventListener('click', loadGroups);
    loadClients();
    showGroupForm(false);
  </script>
</body>
</html>

