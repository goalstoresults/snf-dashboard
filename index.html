<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SNF Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7fafc; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#059669; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .brand{font-weight:700}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;padding:10px 20px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;background:#fdfdfd;
      border-top-left-radius:10px;border-top-right-radius:10px;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--card);color:var(--text);font-weight:600}
    main{padding:18px 20px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .grow{flex:1 1 220px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;
      border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .muted{color:var(--muted)}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;
      justify-content:center;padding:16px;z-index:30}
    .modal{background:#fff;border-radius:16px;max-width:680px;width:100%;border:1px solid var(--border);
      box-shadow:0 8px 28px rgba(0,0,0,.15)}
    .modal header{border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .modal .content{padding:16px}
    /* Autocomplete */
    .ac-wrap{position:relative}
    .ac-list{position:absolute;z-index:40;top:calc(100% + 6px);left:0;right:0;background:#fff;
      border:1px solid var(--border);border-radius:10px;max-height:240px;overflow:auto;
      box-shadow:0 6px 18px rgba(0,0,0,.08);display:none}
    .ac-item{padding:10px 12px;cursor:pointer}
    .ac-item:hover{background:#f4f6fb}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5ff;color:#1e3a8a;
      border-radius:999px;padding:6px 10px;font-size:12px}
    .pill .x{cursor:pointer}
    .error{color:var(--danger);font-size:12px;margin-top:6px}
    .success{color:var(--accent-2);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">SNF Dashboard</div>
    <div id="version">SNF UI v0.2</div>
  </header>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="clients">Clients</div>
    <div class="tab" data-tab="contacts">Contacts</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="groups">Groups</div>
    <div class="tab" data-tab="roi">Group ROI</div>
  </div>

  <main>
    <section class="panel" id="panel-clients">
      <div class="toolbar">
        <div><strong>Clients</strong> <span class="muted">— add and manage clients</span></div>
        <button class="btn primary" id="btn-add-client">+ Add Client</button>
      </div>
      <div class="muted">Client list coming next. For now, use “Add Client”.</div>
    </section>

    <!-- Placeholder panels -->
    <section class="panel" id="panel-contacts" style="display:none"><div class="muted">Contacts placeholder.</div></section>
    <section class="panel" id="panel-payments" style="display:none"><div class="muted">Payments placeholder.</div></section>
    <section class="panel" id="panel-groups" style="display:none"><div class="muted">Groups placeholder.</div></section>
    <section class="panel" id="panel-roi" style="display:none"><div class="muted">Group ROI placeholder.</div></section>
  </main>

  <!-- Add Client Modal -->
  <div class="modal-backdrop" id="add-modal-backdrop">
    <div class="modal">
      <header>
        <div class="brand">Add Client</div>
        <button class="btn" id="btn-close-x">✕</button>
      </header>
      <div class="content">
        <form id="add-client-form" autocomplete="off">
          <div class="row">
            <div class="grow">
              <div class="label">First Name</div>
              <input class="input" name="first_name" required />
            </div>
            <div class="grow">
              <div class="label">Last Name</div>
              <input class="input" name="last_name" required />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <div class="label">Email</div>
              <input class="input" type="email" name="email" />
            </div>
            <div class="grow">
              <div class="label">Phone</div>
              <input class="input" name="phone" placeholder="+15555550123" />
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <div class="label">Referred By (search Last, First or email)</div>
              <div class="ac-wrap">
                <input class="input" id="ref-search" placeholder="e.g., Smith, Jane or jane@company.com" />
                <div class="ac-list" id="ref-list"></div>
              </div>
              <input type="hidden" name="referred_by_id" id="ref-ghl-id" />
              <div id="ref-pill" style="margin-top:8px;display:none;" class="pill">
                <span id="ref-pill-text"></span>
                <span class="x" id="ref-pill-x">✕</span>
              </div>
            </div>
          </div>

          <div id="form-msg" class="muted" style="margin-top:10px"></div>
        </form>
      </div>
      <footer>
        <button class="btn" id="btn-cancel">Cancel</button>
        <button class="btn primary" id="btn-save">Save Client</button>
      </footer>
    </div>
  </div>

  <script>
    // Tabs
    const tabs=document.querySelectorAll('.tab');
    const panels={clients:panel('clients'),contacts:panel('contacts'),
      payments:panel('payments'),groups:panel('groups'),roi:panel('roi')};
    tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');for(const p in panels)panels[p].style.display='none';
      panels[t.dataset.tab].style.display='';});
    function panel(id){return document.getElementById('panel-'+id)}

    // Modal helpers
    const modal=document.getElementById('add-modal-backdrop');
    const openModal=()=>{modal.style.display='flex'};
    const closeModal=()=>{modal.style.display='none';resetForm()};
    document.getElementById('btn-add-client').onclick=openModal;
    document.getElementById('btn-cancel').onclick=closeModal;
    document.getElementById('btn-close-x').onclick=closeModal;

    // Autocomplete
    const refInput=document.getElementById('ref-search');
    const refList=document.getElementById('ref-list');
    const refGhlId=document.getElementById('ref-ghl-id');
    const refPill=document.getElementById('ref-pill');
    const refPillText=document.getElementById('ref-pill-text');
    const refPillX=document.getElementById('ref-pill-x');
    const formMsg=document.getElementById('form-msg');
    refPillX.onclick=()=>{refGhlId.value='';refPill.style.display='none';};

    let acTimer=null;
    refInput.oninput=()=>{const q=refInput.value.trim();
      if(acTimer)clearTimeout(acTimer);
      if(q.length<2){refList.style.display='none';return;}
      acTimer=setTimeout(()=>loadContactMatches(q),250);};

    async function loadContactMatches(q){
      refList.innerHTML='<div class=\"ac-item muted\">Searching…</div>';refList.style.display='block';
      try{
        const url=new URL('/snf-search-contacts',location.origin);
        url.searchParams.set('q',q);url.searchParams.set('limit','10');
        const res=await fetch(url);const data=await res.json();
        if(!res.ok)throw new Error(data.error||'Search failed');
        const rows=data.rows||[];
        if(!rows.length){refList.innerHTML='<div class=\"ac-item muted\">No matches</div>';return;}
        rows.sort((a,b)=>a.last_name.localeCompare(b.last_name)||a.first_name.localeCompare(b.first_name));
        refList.innerHTML='';
        rows.forEach(r=>{
          const d=document.createElement('div');d.className='ac-item';
          const label=`${r.last_name}, ${r.first_name} — ${r.email||'no email'}`;
          d.textContent=label;d.onclick=()=>{
            refGhlId.value=r.ghl_id;refPillText.textContent=label;
            refPill.style.display='inline-flex';refList.style.display='none';refInput.value='';};
          refList.appendChild(d);});
      }catch(e){refList.innerHTML='<div class=\"ac-item\" style=\"color:red\">Error</div>';}
    }

    // Save Client
    document.getElementById('btn-save').onclick=async()=>{
      const fd=new FormData(document.getElementById('add-client-form'));
      const p=Object.fromEntries(fd.entries());
      if(!p.first_name.trim()||!p.last_name.trim())return setMsg('First/Last required',true);
      try{
        setMsg('Saving…');
        const r=await fetch('/snf-add-client',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify(p)});const d=await r.json();
        if(!r.ok)throw new Error(d.error||'Save failed');
        setMsg('Client added!',false,true);setTimeout(closeModal,600);
      }catch(e){setMsg(e.message,true);}
    };
    function setMsg(t,err=false,ok=false){
      formMsg.className=err?'error':(ok?'success':'muted');formMsg.textContent=t;
    }
    function resetForm(){document.getElementById('add-client-form').reset();
      refPill.style.display='none';refList.style.display='none';setMsg('');}
  </script>
</body>
</html>
